<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heavy Machinery Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .status-operational { background-color: #22c55e; color: white; }
        .status-idle { background-color: #f97316; color: white; }
        .status-maintenance { background-color: #ef4444; color: white; }
        .status-leased, .status-available, .status-undergoing-service {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        .status-leased { background-color: #3b82f6; color: white; }
        .status-available { background-color: #14b8a6; color: white; }
        .status-undergoing-service { background-color: #6366f1; color: white; }
        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl opacity-0 transition-opacity duration-500">
        <!-- Role selection toggle -->
        <div class="mb-6 flex justify-center">
            <div class="flex rounded-md shadow-sm">
                <button id="customer-btn" class="role-btn bg-indigo-600 text-white px-6 py-2 rounded-l-md font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Customer View</button>
                <button id="dealer-btn" class="role-btn bg-white text-gray-700 px-6 py-2 rounded-r-md font-semibold hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Dealer View</button>
            </div>
        </div>
        
        <!-- Machine Information Display -->
        <div id="info-container">
            <!-- Dynamic content will be injected here -->
        </div>
    </div>

    <!-- Initial state message / loader -->
    <div id="initial-state" class="flex flex-col items-center justify-center min-h-screen text-center">
        <div id="loader"></div>
        <p class="text-gray-600 mt-4 text-lg font-medium">Fetching machine data...</p>
    </div>


    <script>
        // --- STEP 1: BACKEND DATA STORE (DATABASE SIMULATION) ---
        // In a real application, this data would be in your database.
        const backendDatabase = {
          "machines": [
            { "id": "HM-EX-001", "name": "Excavator", "model": "CAT 320", "imageUrl": "https://placehold.co/600x400/222/FFF?text=Excavator", "customerView": { "Status": "Operational", "Current Fuel": "85%", "Hours Worked Today": "5.2 hrs", "Next Scheduled Service": "In 150 hours", "Location": "Site A, Sector 4", "Operator": "John Doe", "Project": "Highway Expansion" }, "dealerView": { "Status": "Leased", "Fuel Efficiency": "15.5 L/hr", "Total Hours Worked": "2,450 hrs", "Service Life Remaining": "7,550 hrs", "Maintenance History": [ { "date": "2024-07-15", "details": "Replaced hydraulic filter" }, { "date": "2024-06-20", "details": "Engine oil change" } ], "Total Rental Revenue": "$45,000", "Purchase Date": "2022-01-10", "Current Lessee": "ConstructCorp", "Telemetry": { "Engine Temp": "88째C", "Hydraulic Pressure": "3200 psi" } } },
            { "id": "HM-BL-002", "name": "Bulldozer", "model": "Komatsu D65", "imageUrl": "https://placehold.co/600x400/333/FFF?text=Bulldozer", "customerView": { "Status": "Idle", "Current Fuel": "92%", "Hours Worked Today": "0 hrs", "Next Scheduled Service": "In 80 hours", "Location": "Site B, Sector 2", "Operator": "Jane Smith", "Project": "Foundation Work" }, "dealerView": { "Status": "Available", "Fuel Efficiency": "18.2 L/hr", "Total Hours Worked": "1,820 hrs", "Service Life Remaining": "10,180 hrs", "Maintenance History": [ { "date": "2024-08-01", "details": "Track tension adjustment" }, { "date": "2024-07-10", "details": "General inspection" } ], "Total Rental Revenue": "$32,000", "Purchase Date": "2022-05-22", "Current Lessee": "N/A", "Telemetry": { "Engine Temp": "45째C", "Hydraulic Pressure": "500 psi" } } },
            { "id": "HM-LD-003", "name": "Wheel Loader", "model": "Volvo L150H", "imageUrl": "https://placehold.co/600x400/444/FFF?text=Wheel+Loader", "customerView": { "Status": "Maintenance", "Current Fuel": "30%", "Hours Worked Today": "8.1 hrs", "Next Scheduled Service": "Now", "Location": "Main Yard", "Operator": "Mike Johnson", "Project": "Material Handling" }, "dealerView": { "Status": "Undergoing Service", "Fuel Efficiency": "12.8 L/hr", "Total Hours Worked": "3,100 hrs", "Service Life Remaining": "5,900 hrs", "Maintenance History": [ { "date": "2024-08-25", "details": "Transmission fluid change" }, { "date": "2024-08-05", "details": "Replaced bucket teeth" } ], "Total Rental Revenue": "$55,000", "Purchase Date": "2021-11-01", "Current Lessee": "InfraBuilders Ltd.", "Telemetry": { "Engine Temp": "95째C", "Hydraulic Pressure": "3000 psi" } } },
            { "id": "HM-CR-004", "name": "Mobile Crane", "model": "Liebherr LTM 1070", "imageUrl": "https://placehold.co/600x400/555/FFF?text=Mobile+Crane", "customerView": { "Status": "Operational", "Current Fuel": "70%", "Hours Worked Today": "3.5 hrs", "Next Scheduled Service": "In 250 hours", "Location": "Downtown Project", "Operator": "Chris Lee", "Project": "Skyscraper Construction" }, "dealerView": { "Status": "Leased", "Fuel Efficiency": "22.0 L/hr", "Total Hours Worked": "1,200 hrs", "Service Life Remaining": "12,800 hrs", "Maintenance History": [ { "date": "2024-06-30", "details": "Cable inspection and lubrication" }, { "date": "2024-05-15", "details": "Hydraulic system check" } ], "Total Rental Revenue": "$85,000", "Purchase Date": "2023-02-18", "Current Lessee": "HighRise Construction", "Telemetry": { "Engine Temp": "85째C", "Hydraulic Pressure": "3500 psi" } } },
            // ... 96 more entries
          ]
        };

        // --- API ENDPOINT SIMULATION ---
        // This function simulates making a network request to your backend API.
        function fetchMachineDataFromAPI(machineId) {
            console.log(`Simulating API call for machine ID: ${machineId}`);
            return new Promise((resolve, reject) => {
                // Simulate network delay
                setTimeout(() => {
                    const machine = backendDatabase.machines.find(m => m.id === machineId);
                    if (machine) {
                        console.log("Data found:", machine);
                        resolve(machine);
                    } else {
                        console.error("Machine not found in database.");
                        reject(`Machine with ID ${machineId} not found.`);
                    }
                }, 1000); // 1 second delay
            });
        }
        
        // --- FRONTEND APPLICATION LOGIC ---
        const customerBtn = document.getElementById('customer-btn');
        const dealerBtn = document.getElementById('dealer-btn');
        const infoContainer = document.getElementById('info-container');
        const initialStateDiv = document.getElementById('initial-state');
        const appContainerDiv = document.getElementById('app-container');

        let currentRole = 'customer';
        let currentMachineData = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Get machine ID from URL (this simulates the QR code scan)
            const params = new URLSearchParams(window.location.search);
            const machineId = params.get('id');

            if (!machineId) {
                displayError("No machine ID provided in the URL. Please scan a valid QR code.");
                return;
            }

            // Fetch data and render the page
            fetchMachineDataFromAPI(machineId)
                .then(data => {
                    currentMachineData = data;
                    render();
                    initialStateDiv.style.display = 'none';
                    appContainerDiv.style.opacity = 1;
                })
                .catch(error => {
                    displayError(error);
                });
        });

        customerBtn.addEventListener('click', () => {
            currentRole = 'customer';
            updateRoleButtons();
            render();
        });

        dealerBtn.addEventListener('click', () => {
            currentRole = 'dealer';
            updateRoleButtons();
            render();
        });
        
        function updateRoleButtons() {
            if (currentRole === 'customer') {
                customerBtn.classList.add('bg-indigo-600', 'text-white');
                customerBtn.classList.remove('bg-white', 'text-gray-700');
                dealerBtn.classList.add('bg-white', 'text-gray-700');
                dealerBtn.classList.remove('bg-indigo-600', 'text-white');
            } else {
                dealerBtn.classList.add('bg-indigo-600', 'text-white');
                dealerBtn.classList.remove('bg-white', 'text-gray-700');
                customerBtn.classList.add('bg-white', 'text-gray-700');
                customerBtn.classList.remove('bg-indigo-600', 'text-white');
            }
        }

        function getStatusClass(status) {
            const sanitizedStatus = status.toLowerCase().replace(/\s+/g, '-');
            return `status-${sanitizedStatus}`;
        }

        function displayError(message) {
            initialStateDiv.innerHTML = `
                <div class="text-red-500 bg-red-100 p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-2">Error</h2>
                    <p>${message}</p>
                    <p class="mt-4 text-sm text-gray-600">Example URL: .../your_page.html?id=HM-EX-001</p>
                </div>
            `;
        }

        function render() {
            if (!currentMachineData) return;

            const machine = currentMachineData;
            const viewData = currentRole === 'customer' ? machine.customerView : machine.dealerView;
            
            let detailsHtml = '';
            for (const [key, value] of Object.entries(viewData)) {
                if (key.toLowerCase() === 'status') continue;
                if (key.toLowerCase() === 'maintenance history' && Array.isArray(value)) {
                     detailsHtml += `
                        <div class="col-span-1 sm:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">${key}</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <ul class="border border-gray-200 rounded-md divide-y divide-gray-200">
                                    ${value.map(item => `
                                        <li class="pl-3 pr-4 py-3 flex items-center justify-between text-sm">
                                            <div class="w-0 flex-1 flex items-center">
                                                <span class="ml-2 flex-1 w-0 truncate">${item.details}</span>
                                            </div>
                                            <div class="ml-4 flex-shrink-0">
                                                <span class="font-medium text-gray-500">${item.date}</span>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </dd>
                        </div>`;
                } else if (typeof value === 'object' && value !== null) {
                    detailsHtml += `
                        <div class="col-span-1 sm:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">${key}</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <div class="grid grid-cols-2 gap-2 p-2 border rounded-md">
                                    ${Object.entries(value).map(([subKey, subValue]) => `
                                        <div>
                                            <span class="font-medium">${subKey}:</span> ${subValue}
                                        </div>
                                    `).join('')}
                                </div>
                            </dd>
                        </div>`;
                }
                else {
                    detailsHtml += `
                        <div>
                            <dt class="text-sm font-medium text-gray-500">${key}</dt>
                            <dd class="mt-1 text-sm text-gray-900 font-semibold">${value}</dd>
                        </div>`;
                }
            }

            const statusClass = getStatusClass(viewData.Status);
            const dealerStatusClass = currentRole === 'dealer' ? getStatusClass(viewData.Status) : '';

            infoContainer.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="md:flex">
                        <div class="md:flex-shrink-0">
                            <img class="h-48 w-full object-cover md:h-full md:w-64" src="${machine.imageUrl}" alt="${machine.name}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/ccc/FFF?text=Image+Error';">
                        </div>
                        <div class="p-6 md:p-8 flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="uppercase tracking-wide text-sm text-indigo-500 font-semibold">${machine.model}</div>
                                    <h2 class="block mt-1 text-2xl leading-tight font-bold text-black">${machine.name}</h2>
                                    <p class="mt-2 text-gray-500">ID: ${machine.id}</p>
                                </div>
                                ${currentRole === 'customer' 
                                    ? `<div class="px-3 py-1 text-sm font-bold rounded-full ${statusClass}">${viewData.Status}</div>`
                                    : `<span class="${dealerStatusClass}">${viewData.Status}</span>`
                                }
                            </div>

                            <div class="mt-6 border-t border-gray-200 pt-6">
                                <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6">
                                    ${detailsHtml}
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
